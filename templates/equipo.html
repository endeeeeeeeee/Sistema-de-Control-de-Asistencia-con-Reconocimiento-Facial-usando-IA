<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Equipo - CLASS VISION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-600: #475569;
            --gray-900: #0f172a;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-button {
            background: white;
            color: var(--dark);
            padding: 12px 24px;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .team-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .team-title {
            font-size: 32px;
            color: var(--dark);
            margin-bottom: 12px;
        }

        .team-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .meta-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .type-universidad { background: #dbeafe; color: #1e40af; }
        .type-colegio { background: #d1fae5; color: #065f46; }
        .type-guarderia { background: #fce7f3; color: #9f1239; }
        .type-empresa { background: #fef3c7; color: #92400e; }
        .type-gym { background: #e9d5ff; color: #6b21a8; }
        .type-otro { background: #f1f5f9; color: #475569; }

        .invitation-code {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .invitation-code h3 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .code-display {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .members-table {
            width: 100%;
            border-collapse: collapse;
        }

        .members-table thead {
            background: var(--light);
        }

        .members-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .members-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-lider { background: #fef3c7; color: #92400e; }
        .role-colider { background: #e0e7ff; color: #3730a3; }
        .role-miembro { background: #f1f5f9; color: #475569; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .members-table {
                font-size: 14px;
            }

            .members-table th,
            .members-table td {
                padding: 12px 8px;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/dashboard" class="back-button">
            ‚Üê Volver al Dashboard
        </a>

        <div id="loading" class="section">
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando informaci√≥n del equipo...</p>
            </div>
        </div>

        <div id="teamContent" style="display: none;">
            <!-- Team Header -->
            <div class="team-header">
                <h1 class="team-title" id="teamName">Nombre del Equipo</h1>
                <div class="team-meta">
                    <span class="meta-badge" id="teamTypeBadge">UNIVERSIDAD</span>
                    <span class="meta-badge" id="myRoleBadge">MIEMBRO</span>
                </div>
                <p id="teamDescription" style="color: #64748b; line-height: 1.6;"></p>
                
                <div class="invitation-code">
                    <h3>C√≥digo de Invitaci√≥n</h3>
                    <div class="code-display" id="invitationCode">TEAM-ABC123</div>
                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.9;">Comparte este c√≥digo para invitar nuevos miembros</p>
                </div>
            </div>

            <!-- Team Stats -->
            <div class="section">
                <h2 class="section-title">Estad√≠sticas del Equipo</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalMiembros">0</div>
                        <div class="stat-label">Miembros Totales</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="asistenciasHoy">0</div>
                        <div class="stat-label">Asistencias Hoy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="promedioAsistencia">0%</div>
                        <div class="stat-label">Promedio Asistencia</div>
                    </div>
                </div>
            </div>

            <!-- Members List -->
            <div class="section">
                <h2 class="section-title">Miembros del Equipo</h2>
                <div id="membersContent"></div>
            </div>

            <!-- Actions for Leaders -->
            <div id="leaderActions" class="section" style="display: none;">
                <h2 class="section-title">Acciones de Administrador</h2>
                
                <!-- Modo Guarder√≠a Toggle -->
                <div id="modoGuarderiaContainer" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 3px dashed #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 48px; margin-bottom: 8px;">üß∏</div>
                        <h3 style="color: #92400e; margin-bottom: 8px; font-size: 20px; font-weight: 700;">üß∏ MODO GUARDER√çA</h3>
                        <p style="color: #78350f; font-size: 14px; margin: 0 0 12px 0; font-weight: 500;">Seguridad reforzada para protecci√≥n infantil</p>
                    </div>
                    
                    <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin: 0 0 12px 0; font-size: 15px;">Caracter√≠sticas de Seguridad:</h4>
                        <ul style="color: #78350f; font-size: 13px; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Verificaci√≥n Dual:</strong> Tutor + Ni√±o</li>
                            <li><strong>Registro Fotogr√°fico:</strong> Cada entrada/salida</li>
                            <li><strong>Control de Horarios:</strong> Alertas autom√°ticas</li>
                            <li><strong>Log Completo:</strong> Qui√©n recogi√≥ al ni√±o y cu√°ndo</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; background: #fed7aa; padding: 12px; border-radius: 8px;">
                        <div style="flex: 1;">
                            <span style="color: #92400e; font-weight: 600; font-size: 14px;">üîí Estado del Modo de Seguridad</span>
                        </div>
                        <label style="display: flex; align-items: center; cursor: pointer; background: white; padding: 8px 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="margin-right: 10px; font-weight: 600; color: #92400e; font-size: 13px;">Activar</span>
                            <input type="checkbox" id="modoGuarderiaToggle" onchange="toggleModoGuarderia(this.checked)" style="width: 22px; height: 22px; cursor: pointer;">
                        </label>
                    </div>
                    
                    <div style="margin-top: 12px; text-align: center; font-size: 11px; color: #92400e; opacity: 0.8;">
                        üöß <em>Funcionalidad en desarrollo - Demo visual</em>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="iniciarSesionAsistencia()" style="
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    font-size: 16px;
                    padding: 14px 28px;
                    margin-bottom: 12px;
                ">
                    üìπ Iniciar Sesi√≥n de Asistencia
                </button>
                <button class="btn btn-primary" onclick="editTeam()">
                    ‚úèÔ∏è Editar Equipo
                </button>
                <button class="btn btn-primary" onclick="verReportes()">
                    Ver Reportes Detallados
                </button>
                <button class="btn btn-primary" onclick="generarQRVinculacion()">
                    Generar QR Dispositivo
                </button>
                <button class="btn btn-danger" onclick="confirmDeleteTeam()">
                    Eliminar Equipo
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('authToken');
        let currentTeam = null;
        const teamId = window.location.pathname.split('/').pop();

        document.addEventListener('DOMContentLoaded', async () => {
            if (!authToken) {
                window.location.href = '/login';
                return;
            }
            await loadTeamDetails();
        });

        async function loadTeamDetails() {
            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentTeam = data;
                    renderTeam(data);
                } else {
                    alert(data.error || 'Error al cargar equipo');
                    window.location.href = '/dashboard';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        async function renderTeam(data) {
            const { equipo, miembros } = data;

            // Header
            document.getElementById('teamName').textContent = equipo.nombre_equipo;
            document.getElementById('teamDescription').textContent = equipo.descripcion || 'Sin descripci√≥n';
            document.getElementById('invitationCode').textContent = equipo.codigo_invitacion;

            // Type Badge
            const typeBadge = document.getElementById('teamTypeBadge');
            typeBadge.textContent = equipo.tipo_equipo.toUpperCase();
            typeBadge.className = `meta-badge type-${equipo.tipo_equipo}`;

            // Role Badge
            const roleBadge = document.getElementById('myRoleBadge');
            const roleText = {
                'lider': 'L√çDER',
                'co-lider': 'üéñÔ∏è CO-L√çDER',
                'miembro': 'üë§ MIEMBRO'
            }[equipo.mi_rol] || equipo.mi_rol.toUpperCase();
            roleBadge.textContent = roleText;
            roleBadge.className = `meta-badge role-${equipo.mi_rol}`;

            // Cargar estad√≠sticas en tiempo real
            await loadRealTimeStats();

            // Members Table
            renderMembers(miembros);

            // Leader Actions
            if (equipo.mi_rol === 'lider' || equipo.mi_rol === 'co-lider') {
                document.getElementById('leaderActions').style.display = 'block';
                
                // Mostrar toggle de guarder√≠a si aplica
                if (equipo.tipo_equipo === 'guarderia') {
                    document.getElementById('modoGuarderiaContainer').style.display = 'block';
                }
            }

            // Show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('teamContent').style.display = 'block';
            
            // Actualizar stats cada 30 segundos
            setInterval(loadRealTimeStats, 30000);
        }

        async function loadRealTimeStats() {
            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalMiembros').textContent = data.stats.total_miembros;
                    document.getElementById('asistenciasHoy').textContent = data.stats.asistencias_hoy;
                    document.getElementById('promedioAsistencia').textContent = `${data.stats.promedio_asistencia}%`;
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        function renderMembers(miembros) {
            const container = document.getElementById('membersContent');

            if (miembros.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>No hay miembros en este equipo</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Asistencias</th>
                            <th>%</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            miembros.forEach(member => {
                const roleClass = `role-${member.rol}`;
                const roleText = {
                    'lider': 'L√≠der',
                    'co-lider': 'üéñÔ∏è Co-L√≠der',
                    'miembro': 'üë§ Miembro'
                }[member.rol] || member.rol;

                // Obtener membresia_id del currentTeam
                const memberData = currentTeam.miembros.find(m => m.id === member.id);
                const membresiaId = memberData ? memberData.id : member.id;

                html += `
                    <tr>
                        <td><strong>${member.codigo_usuario}</strong></td>
                        <td>${member.nombre_completo}</td>
                        <td><span class="role-badge ${roleClass}">${roleText}</span></td>
                        <td>${member.asistencias_totales} / ${member.asistencias_totales + member.faltas_totales}</td>
                        <td>${Math.round(member.porcentaje_asistencia)}%</td>
                        <td>
                            ${canManageMember(member.rol) ? `
                                <button class="btn btn-primary btn-sm" onclick="changeRole('${member.codigo_usuario}', '${member.rol}')" style="background: #6366f1; margin-right: 4px;">
                                    üë§ Cambiar Rol
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="removeMember('${member.codigo_usuario}', '${member.nombre_completo}')">
                                    Remover
                                </button>
                            ` : '-'}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function canManageMember(memberRole) {
            if (!currentTeam) return false;
            const myRole = currentTeam.equipo.mi_rol;

            // Solo l√≠der puede remover
            if (myRole === 'lider') {
                return memberRole !== 'lider'; // No puede removerse a s√≠ mismo
            }
            return false;
        }

        async function removeMember(codigoUsuario, nombreCompleto) {
            if (!confirm(`¬øEst√°s seguro de remover a ${nombreCompleto} del equipo?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}/miembros/by-codigo/${codigoUsuario}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        loadTeamDetails(); // Recargar miembros despu√©s de 1 seg
                    }, 1000);
                } else {
                    showNotification('Error: ' + (data.error || 'No se pudo remover el miembro'), 'error');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n', 'error');
                console.error('Error:', error);
            }
        }

        async function changeRole(codigoUsuario, currentRole) {
            const roles = ['miembro', 'co-lider', 'lider'];
            const roleNames = {
                'miembro': 'Miembro',
                'co-lider': 'Co-L√≠der',
                'lider': 'L√≠der'
            };
            
            let options = roles.filter(r => r !== currentRole)
                .map(r => `${r}: ${roleNames[r]}`)
                .join('\n');
            
            const nuevoRol = prompt(`Cambiar rol del miembro:\n\nOpciones:\n${options}\n\nIngresa el nuevo rol (miembro/co-lider/lider):`);
            
            if (!nuevoRol || !roles.includes(nuevoRol)) {
                showNotification('Rol inv√°lido', 'error');
                return;
            }
            
            if (nuevoRol === currentRole) {
                showNotification('El miembro ya tiene ese rol', 'info');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}/miembros/by-codigo/${codigoUsuario}/rol`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rol: nuevoRol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        loadTeamDetails(); // Recargar miembros despu√©s de 1 seg
                    }, 1000);
                } else {
                    showNotification('Error: ' + (data.error || 'No se pudo cambiar el rol'), 'error');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n', 'error');
                console.error('Error:', error);
            }
        }

        function toggleModoGuarderia(isActive) {
            if (isActive) {
                showNotification('üîí MODO GUARDER√çA ACTIVADO\n\nüöß Demo Visual - Funcionalidad completa requerir√≠a:\n‚Ä¢ Base de datos de tutores autorizados\n‚Ä¢ Reconocimiento facial dual (tutor + ni√±o)\n‚Ä¢ Sistema de alertas y notificaciones\n‚Ä¢ Registro fotogr√°fico de cada salida\n\nüë∂ Pensado para m√°xima seguridad infantil', 'info');
            } else {
                showNotification('üîì Modo Guarder√≠a desactivado - Sistema est√°ndar de asistencia', 'info');
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#6366f1',
                warning: '#f59e0b'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 350px;
                animation: slideIn 0.3s ease;
                white-space: pre-line;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function editTeam() {
            const nuevoNombre = prompt('Nuevo nombre del equipo:', currentTeam?.nombre_equipo || '');
            
            if (!nuevoNombre || nuevoNombre.trim() === '') {
                return;
            }
            
            const nuevaDescripcion = prompt('Nueva descripci√≥n (opcional):', currentTeam?.descripcion || '');

            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}/editar`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        nombre_equipo: nuevoNombre,
                        descripcion: nuevaDescripcion
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadTeamDetails(); // Recargar detalles
                } else {
                    alert('Error: ' + (data.error || 'No se pudo editar el equipo'));
                }
            } catch (error) {
                alert('Error de conexi√≥n');
                console.error('Error:', error);
            }
        }

        let isDeletingTeam = false;

        async function confirmDeleteTeam() {
            if (isDeletingTeam) {
                alert('Ya se est√° eliminando el equipo, por favor espera...');
                return;
            }

            if (!confirm('¬øEst√°s seguro de eliminar este equipo? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            if (!confirm('√öLTIMA ADVERTENCIA: Se eliminar√°n todos los miembros y registros de asistencia. ¬øContinuar?')) {
                return;
            }
            
            isDeletingTeam = true;
            const deleteBtn = document.querySelector('.btn-danger[onclick="confirmDeleteTeam()"]');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Eliminando...';
            }
            
            console.log('Eliminando equipo con ID:', teamId);
            console.log('Token:', authToken ? 'Presente' : 'Ausente');
            
            try {
                const response = await fetch(`${API_BASE}/equipos/${teamId}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    alert(data.message);
                    window.location.href = '/dashboard';
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar el equipo'));
                    isDeletingTeam = false;
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'Eliminar Equipo';
                    }
                }
            } catch (error) {
                alert('Error de conexi√≥n al eliminar el equipo');
                console.error('Error completo:', error);
                isDeletingTeam = false;
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Eliminar Equipo';
                }
            }
        }

        // =====================================================
        // GENERAR QR INDIVIDUAL
        // =====================================================

        let qrExpirationTimer = null;

        async function generateIndividualQR(usuarioId, nombreUsuario) {
            try {
                const response = await fetch(`${API_BASE}/qr/generar-individual`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        equipo_id: parseInt(teamId),
                        usuario_id: usuarioId,
                        duracion_minutos: 5
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showQRModal(data);
                } else {
                    alert(data.error || 'No se pudo generar el QR');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n al generar QR');
            }
        }

        function showQRModal(qrData) {
            // Calcular tiempo restante
            const expiraEn = new Date(qrData.expira_en);
            const ahora = new Date();
            const tiempoRestante = Math.floor((expiraEn - ahora) / 1000); // segundos

            // Crear modal
            const modal = document.createElement('div');
            modal.id = 'qrModal';
            modal.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                ">
                    <div style="
                        background: white;
                        border-radius: 16px;
                        padding: 32px;
                        max-width: 500px;
                        width: 100%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    ">
                        <h2 style="margin: 0 0 16px; color: #1e293b;">üé´ QR de Un Solo Uso</h2>
                        <p style="color: #64748b; margin-bottom: 24px;">
                            Para: <strong>${qrData.usuario_nombre}</strong>
                        </p>

                        <!-- QR Code -->
                        <div id="qrcode" style="
                            background: white;
                            padding: 20px;
                            border-radius: 12px;
                            border: 2px solid #e2e8f0;
                            margin-bottom: 24px;
                            display: inline-block;
                        "></div>

                        <!-- C√≥digo manual -->
                        <div style="
                            background: #f8fafc;
                            padding: 16px;
                            border-radius: 8px;
                            margin-bottom: 16px;
                        ">
                            <p style="margin: 0 0 8px; color: #64748b; font-size: 14px;">
                                C√≥digo Manual:
                            </p>
                            <code style="
                                font-size: 16px;
                                font-weight: 600;
                                color: #1e293b;
                                letter-spacing: 2px;
                            ">${qrData.qr_code}</code>
                        </div>

                        <!-- Cuenta regresiva -->
                        <div style="
                            background: #fef3c7;
                            padding: 12px;
                            border-radius: 8px;
                            margin-bottom: 24px;
                        ">
                            <p style="margin: 0; color: #92400e; font-size: 14px;">
                                ‚è±Ô∏è Expira en: <strong id="qrTimer">${tiempoRestante}s</strong>
                            </p>
                        </div>

                        <!-- Botones -->
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="copyQRCode('${qrData.qr_code}')" style="
                                padding: 12px 24px;
                                background: #6366f1;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Copiar C√≥digo
                            </button>
                            <button onclick="closeQRModal()" style="
                                padding: 12px 24px;
                                background: #e2e8f0;
                                color: #1e293b;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                            ">
                                Cerrar
                            </button>
                        </div>

                        <p style="margin: 16px 0 0; color: #94a3b8; font-size: 12px;">
                            Este QR solo se puede usar UNA VEZ
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Generar QR con QRCode.js
            const qrcode = new QRCode(document.getElementById('qrcode'), {
                text: `${window.location.origin}/validar-qr?code=${qrData.qr_code}`,
                width: 256,
                height: 256,
                colorDark: '#1e293b',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            // Iniciar cuenta regresiva
            startQRTimer(tiempoRestante);
        }

        function startQRTimer(segundosRestantes) {
            const timerElement = document.getElementById('qrTimer');
            let segundos = segundosRestantes;

            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
            }

            qrExpirationTimer = setInterval(() => {
                segundos--;

                if (segundos <= 0) {
                    clearInterval(qrExpirationTimer);
                    timerElement.textContent = 'EXPIRADO';
                    timerElement.parentElement.style.background = '#fee2e2';
                    timerElement.parentElement.style.color = '#991b1b';
                    return;
                }

                const minutos = Math.floor(segundos / 60);
                const segs = segundos % 60;
                timerElement.textContent = `${minutos}:${segs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function copyQRCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                alert('C√≥digo copiado al portapapeles');
            }).catch(err => {
                console.error('Error:', err);
                alert('No se pudo copiar el c√≥digo');
            });
        }

        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.remove();
            }
            if (qrExpirationTimer) {
                clearInterval(qrExpirationTimer);
                qrExpirationTimer = null;
            }
        }

        // =====================================================
        // INICIAR SESI√ìN DE ASISTENCIA
        // =====================================================

        function iniciarSesionAsistencia() {
            if (!currentTeam || !currentTeam.equipo) {
                alert('‚ùå Error: No se pudo cargar la informaci√≥n del equipo');
                return;
            }

            // Redirigir a la p√°gina de sesi√≥n de asistencia
            window.location.href = `/sesion-asistencia?equipo_id=${teamId}`;
        }

        async function generarQRVinculacion() {
            try {
                const response = await fetch(`${API_BASE}/dispositivos/vincular`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ equipo_id: teamId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Crear modal para mostrar QR
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 500px; text-align: center;">
                            <h2 style="color: #1e293b; margin-bottom: 16px;">Vincular Dispositivo M√≥vil</h2>
                            <p style="color: #64748b; margin-bottom: 24px;">
                                Escanea este c√≥digo QR con tu celular para convertirlo en controlador de asistencia
                            </p>
                            <img src="${data.qr_base64}" style="width: 280px; height: 280px; border: 4px solid #6366f1; border-radius: 12px; margin-bottom: 16px;">
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                                <p style="margin: 0; color: #92400e; font-size: 14px;">
                                    ‚è±Ô∏è Expira en: <strong>${data.expira_en} minutos</strong>
                                </p>
                            </div>
                            <p style="font-size: 12px; color: #64748b; margin-bottom: 20px;">
                                C√≥digo: <code style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-family: monospace;">${data.codigo}</code>
                            </p>
                            <button onclick="this.parentElement.parentElement.remove()" style="
                                padding: 12px 32px;
                                background: #6366f1;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Cerrar</button>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'No se pudo generar el QR'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n');
                console.error('Error:', error);
            }
        }

        function verReportes() {
            // Ir a reportes con filtro pre-seleccionado del equipo
            window.location.href = `/reportes?equipo_id=${teamId}`;
        }
    </script>

    <!-- QRCode.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>
